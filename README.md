# Инфраструктура компании DORA FOND

Инфраструктура компании DORA FOND состоит из 4 серверов. Для их создания в облаке Timeweb Cloud использовалась утилита Terraform, которая автоматически создала все 4 сервера, и добавила ssh ключи администраторов для доступа к ним. В папке **terraform** в файле **main.tf** есть более подробное описание.

Чтобы запустить исполнение Terraform манифеста нужно ввести всего одну команду (её исполнение занимает около 20 секунд, создание серверов около минуты):

```bash
$ terraform apply
```

Технические хар-ки серверов:

<details><summary><b>Gitlab</b></summary>

|cpu|ram|disk|
|:---|:---|:---|
|4 cores|6 Gb|50 Gb|

</details>

<details><summary><b>Gitlab runner</b></summary>

|cpu|ram|disk|
|:---|:---|:---|
|2 cores|4 Gb|30 Gb|

</details>

<details><summary><b>Stage</b></summary>

|cpu|ram|disk|
|:---|:---|:---|
|2 cores|4 Gb|30 Gb|

</details>

<details><summary><b>Production</b></summary>

|cpu|ram|disk|
|:---|:---|:---|
|2 cores|4 Gb|30 Gb|

</details>

</br>

Ниже схематично изображена инфраструктура:

![infra](images/dora.png)

</br>

Далее, была проведена первичная настройка, и установка дополнительного ПО с помощью **Ansible**.

Был описан Playbook, и подготовлены конфигурационные файлы для установки и настройки ПО, а именно:

1. Установка Docker и Docker Compose на всех серверах;
2. Создание новых пользователей на всех серверах;
3. Добавление ssh ключей для новых пользователей;
4. Копирование файлов gitlab для его разворачивания на сервере одноименном сервере;
5. Копирование гит репозитория defectdojo для его разворачивания на сервере Gitlab;
6. Копирование файлов HashiCorp Vault для его разорачивания на сервере Gitlab;
7. Копирование файлов Nginx для его разворачивания на сервере Gitlab;
8. Копирование файлов dockerhub mirror для его разворачивания на сервере Gitlab;
9. Получение ssl сертификатов с помощью Let's Encrypt Certbot;
10. Разворачивание Nginx
11. Разворачивание GitLab;
12. Разворачивание DefectDojo;
13. Разворачивание HashiCorp Vault;
14. Разворачивание DockerHub proxy mirror;
15. Скачивание пакета и установка gitlab-runner на одноименном сервере;
16. Создание файла daemon.json из шаблона, для скачивания докер образов из зеркала DockerHub на сервере Gitlab Runner;
17. Конфигурирование ssh на всех серверах;

Исполнение данного плейбука занимает около 16 минут, после чего инфраструктура будет готова к работе.

Чтобы запустить плейбук, нужно заполнить файл inventory_init.ini, а так же добавить доменные A записи к соответствующим серверам, после чего исполнить команду:

```bash
$ ansible-playbook -i inventory/inventory_init.ini configure_servers.yaml
```

После его исполнения следует проверить подключения к серверам с помощью следующей команды (перед её выполнение следует заполнить файл inventory.ini, по аналогии с inventory_init.ini):

```bash
$ ansible all -i inventory/inventory.ini -m ping -v 
```

Если все сервера ответили, то инфраструктура готова, и можно приступать к выстраиванию процессов DevSecOps.

